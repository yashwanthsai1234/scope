# Implementation Plan

Vertical slices — each slice is a working feature end-to-end.

---

## Slice 1: Spawn a session and see it ✓

**Goal:** `scope spawn "task"` creates a tmux session with Claude Code, returns ID.

**Status:** Done

---

## Slice 2: Poll session status ✓

**Goal:** `scope poll <id>` returns session state as JSON.

**Status:** Done

---

## Slice 3: Minimal TUI ✓

**Goal:** `scope top` shows list of sessions, refreshes on file changes.

**Status:** Done

---

## Slice 4: Create session from TUI ✓

**Goal:** Press `n` in TUI, spawns session in split pane.

**Status:** Done (but UX needs fix in Slice 5)

---

## Slice 5: Fix UX - Native tmux Experience ✓

**Goal:** Make scope feel native. No tmux knowledge required.

**Problems with current implementation:**
- Sessions are tmux windows → `select_window` loses scope TUI
- User needs tmux knowledge to navigate back
- No split view (can't see scope + session simultaneously)
- Entry point is `scope top` and requires being in tmux

**Solution:**
1. Each session = independent tmux session (not window)
2. `scope` auto-launches tmux if not in it
3. Attach = split pane with `tmux attach`, not window switch
4. Close pane = detach (session keeps running)

**Files:**
- `src/scope/core/tmux.py` — Restructure: sessions not windows
  - Remove: `create_window`, `select_window`, `SCOPE_SESSION`
  - Add: `create_session(name, cmd, cwd, env)` — independent tmux session
  - Add: `attach_in_split(session_name)` — `tmux split-window -h "tmux attach -t ..."`
  - Add: `in_tmux()` — check if running inside tmux
- `src/scope/cli.py` — Change default command from `top` to auto-launch logic
- `src/scope/tui/app.py` — Update `action_new_session` and `on_row_selected`
- `src/scope/commands/spawn.py` — Use `create_session` not `create_window`

**Test:**
1. Run `scope` outside tmux → auto-launches tmux with scope inside
2. Press `n` → split appears with Claude Code on right
3. Press `enter` on session → split appears attached to that session
4. Close right pane (Ctrl-D) → back to scope TUI, session still running
5. Press `q` → exits scope, sessions continue in background

---

## Slice 6: Abort session ✓

**Goal:** `scope abort <id>` and `x` in TUI kills session.

**Files:**
- `src/scope/core/tmux.py` — add kill_session
- `src/scope/core/state.py` — add update_state
- `src/scope/commands/abort.py` — abort command
- `src/scope/tui/app.py` — action_abort

**Test:** Spawn, abort, verify tmux session gone, state file says "aborted".

---

## Slice 7: Activity tracking via hooks ✓

**Goal:** Hooks update activity file as Claude works.

**Files:**
- `src/scope/hooks/handler.py` — scope-hook command (activity event)
- `src/scope/hooks/install.py` — install_hooks function
- `src/scope/commands/setup.py` — setup command (just hooks for now)

**Test:** Run `scope setup`, spawn session, do something in Claude, see activity file update.

---

## Slice 8: Wait for completion ✓

**Goal:** `scope wait <id>` blocks until session completes.

**Status:** Done

**Files:**
- `src/scope/commands/wait.py` — wait command with watchfiles
- `src/scope/hooks/handler.py` — stop hook captures final response to result file

**Test:** Spawn, `scope wait 0 &`, complete session, wait returns with result.

---

## Slice 9: Nested sessions

**Goal:** Claude can `scope spawn` to create child sessions.

**Files:**
- `src/scope/core/state.py` — next_id handles parent prefix
- `src/scope/core/session.py` — add parent field
- `src/scope/tui/widgets/session_tree.py` — tree view with hierarchy

**Test:** Spawn parent, inside it spawn child, see 0.0 in tree under 0.

---

## Slice 10: Contract generation

**Goal:** Spawned sessions get injected contract.

**Files:**
- `src/scope/core/contract.py` — generate_contract

**Test:** Spawn with `--input`, verify contract.md has correct content.

---

## Slice 11: Setup with tmux check ✓

**Goal:** `scope setup` checks for tmux, offers to install. Sets up Claude.MD to educate Claude about how to use scope CLI, when to use it.

**Status:** Done

**Files:**
- `src/scope/core/tmux.py` — add is_installed
- `src/scope/commands/setup.py` — tmux check logic
- `src/scope/hooks/install.py` — install_claude_md function

---

## Slice 12: Polish TUI

**Goal:** Keyboard navigation, expand/collapse, hide done.

**Files:**
- `src/scope/tui/app.py` — remaining keybindings
- `src/scope/tui/widgets/session_tree.py` — expand/collapse state

---

## Summary

| Slice | Feature | E2E Test |
|-------|---------|----------|
| 1 | spawn | Creates tmux + files |
| 2 | poll | Returns status JSON |
| 3 | top (basic) | Shows sessions |
| 4 | new from TUI | Split pane opens |
| 5 | attach | Split pane to existing |
| 6 | abort | Kills session |
| 7 | activity hooks | Live activity updates |
| 8 | wait | Blocks until done |
| 9 | nesting | Parent/child sessions |
| 10 | contracts | Injected prompts |
| 11 | setup | tmux check + hooks |
| 12 | TUI polish | Full keybindings |

Start with Slice 1. Each slice is testable independently.
